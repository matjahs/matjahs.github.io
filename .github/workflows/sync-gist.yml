name: Sync resume from gist

on:
  schedule:
    - cron: "15 * * * *"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: sync-gist
  cancel-in-progress: true

jobs:
  sync:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.2

      - name: Fetch gist content
        id: gist
        env:
          GIST_URL: https://gist.githubusercontent.com/matjahs/00071c5d8c74d4a9c7b88b856b31fd63/raw/resume.json
        run: |
          set -euo pipefail
          curl -fsSL "$GIST_URL" -o resume.json.new

          if [ -f resume.json ] && cmp -s resume.json.new resume.json; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
            rm resume.json.new
            exit 0
          fi

          mv resume.json.new resume.json
          echo "changed=true" >> "$GITHUB_OUTPUT"

      - name: Create pull request
        if: steps.gist.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v8
        with:
          commit-message: "chore: sync resume.json from gist"
          title: "chore: sync resume.json from gist"
          body: "Automated update from https://gist.github.com/matjahs/00071c5d8c74d4a9c7b88b856b31fd63."
          branch: "chore/sync-resume-gist"
          delete-branch: true
          add-paths: |
            resume.json
